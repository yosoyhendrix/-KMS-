#!/bin/bash

# Este script configura Fluxbox y TigerVNC Server para un usuario específico en Debian 12.
# No instala paquetes, solo genera los archivos de configuración necesarios.

# --- Configuración ---
TARGET_USER="ogp_agent" # ¡¡¡CAMBIA ESTE VALOR AL NOMBRE DE TU USUARIO!!!
USER_HOME="/home/$TARGET_USER"
VNC_DISPLAY=":1" # Puedes cambiar esto si quieres un display VNC diferente (ej. :2, :3)
GEOMETRY="1280x800" # Resolución de la sesión VNC
DEPTH="24"           # Profundidad de color de la sesión VNC

# --- Funciones ---

log_message() {
    # Solo para fines de salida en terminal, no usaremos un log file persistente.
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1"
}

check_user_home() {
    if [ ! -d "$USER_HOME" ]; then
        log_message "Error: El directorio de inicio del usuario '$TARGET_USER' ($USER_HOME) no existe."
        log_message "Por favor, asegúrate de que el usuario '$TARGET_USER' exista antes de ejecutar este script."
        exit 1
    fi
    log_message "Directorio de inicio del usuario '$TARGET_USER' verificado: $USER_HOME"
}

# --- Inicio del Script ---

log_message "Iniciando la generación de archivos de configuración para Fluxbox y TigerVNC para el usuario '$TARGET_USER'."

check_user_home

# 1. Crear directorios de configuración si no existen
log_message "Creando directorios de configuración .fluxbox y .vnc para el usuario '$TARGET_USER'..."
mkdir -p "$USER_HOME/.fluxbox"
mkdir -p "$USER_HOME/.vnc"
log_message "Directorios creados."

# 2. Configuración de Fluxbox: Archivo 'startup'
log_message "Generando el archivo ~/.fluxbox/startup para Fluxbox..."
FLUXBOX_STARTUP_FILE="$USER_HOME/.fluxbox/startup"

# Creamos o sobrescribimos el archivo de inicio de Fluxbox
cat <<EOL > "$FLUXBOX_STARTUP_FILE"
#!/bin/bash

# Este script se ejecuta al iniciar una sesión de Fluxbox.
# Asegúrate de que las aplicaciones necesarias estén instaladas en el sistema.

# Evitar que se inicie un escritorio ya existente
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS

# Iniciar policykit para permitir la autenticación gráfica (ej. para network-manager-gnome)
# Asegúrate de que 'policykit-1-gnome' esté instalado.
if which /usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1 > /dev/null; then
    /usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1 &
fi

# Iniciar ROX-Filer para el escritorio (pinboard) y como gestor de archivos
# Asegúrate de que 'rox-filer' esté instalado.
# 'rox -S &' permite iconos en el escritorio.
rox -S &

# Establecer el fondo de pantalla (opcional, requiere 'feh')
# Asegúrate de que 'feh' esté instalado si quieres usarlo para imágenes.
xsetroot -solid "#2E3436" & # Un gris oscuro por defecto

# Iniciar el gestor de red (NetworkManager Applet)
# Asegúrate de que 'network-manager-gnome' esté instalado.
nm-applet &

# Iniciar Fluxbox
exec fluxbox
EOL

# Dar permisos de ejecución
chmod +x "$FLUXBOX_STARTUP_FILE"
log_message "Archivo '$FLUXBOX_STARTUP_FILE' generado y con permisos de ejecución."

# 3. Configuración de TigerVNC: Archivo 'xstartup'
log_message "Generando el archivo ~/.vnc/xstartup para TigerVNC..."
VNC_XSTARTUP_FILE="$USER_HOME/.vnc/xstartup"

# Creamos o sobrescribimos el archivo xstartup de VNC
cat <<EOL > "$VNC_XSTARTUP_FILE"
#!/bin/bash

# Este script se ejecuta al iniciar una sesión VNC.
# Asegúrate de que las aplicaciones necesarias estén instaladas en el sistema.

# Evitar que se inicie un escritorio ya existente
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS

# Iniciar policykit para permitir la autenticación gráfica (ej. para network-manager-gnome)
# Asegúrate de que 'policykit-1-gnome' esté instalado.
if which /usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1 > /dev/null; then
    /usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1 &
fi

# Iniciar ROX-Filer para el escritorio (pinboard) y como gestor de archivos
# Asegúrate de que 'rox-filer' esté instalado.
# 'rox -S &' permite iconos en el escritorio.
rox -S &

# Establecer el fondo de pantalla (opcional, requiere 'feh')
# Asegúrate de que 'feh' esté instalado si quieres usarlo para imágenes.
xsetroot -solid "#2E3436" & # Un gris oscuro por defecto

# Iniciar el gestor de red (NetworkManager Applet)
# Asegúrate de que 'network-manager-gnome' esté instalado.
nm-applet &

# Iniciar Fluxbox
exec fluxbox
EOL

# Dar permisos de ejecución
chmod +x "$VNC_XSTARTUP_FILE"
log_message "Archivo '$VNC_XSTARTUP_FILE' generado y con permisos de ejecución."

# 4. Establecer la contraseña de VNC para el usuario
log_message "Solicitando la configuración de la contraseña VNC para el usuario '$TARGET_USER'."
log_message "Por favor, introduce la contraseña VNC (y una opcional de solo lectura) cuando se te solicite."
# Ejecutamos vncpasswd como el usuario destino para que el archivo password se cree con los permisos correctos.
sudo -u "$TARGET_USER" vncpasswd

log_message "Configuración de Fluxbox y TigerVNC para el usuario '$TARGET_USER' completada."
log_message "--------------------------------------------------------------------------------"
log_message "Para que esta configuración funcione, asegúrate de que los siguientes paquetes estén instalados:"
log_message "- xserver-xorg"
log_message "- fluxbox"
log_message "- rox-filer"
log_message "- tigervnc-standalone-server"
log_message "- tigervnc-common"
log_message "- firefox-esr (o tu navegador preferido)"
log_message "- terminator (o tu terminal preferida)"
log_message "- policykit-1-gnome"
log_message "- feh"
log_message "- network-manager-gnome"
log_message "--------------------------------------------------------------------------------"
log_message "Para iniciar el servidor VNC (después de instalar los paquetes):"
log_message "sudo systemctl start vncserver@${VNC_DISPLAY//:/}.service"
log_message "Para que inicie automáticamente al reiniciar:"
log_message "sudo systemctl enable vncserver@${VNC_DISPLAY//:/}.service"
log_message "Asegúrate de abrir el puerto VNC (por ejemplo, 5901) en tu firewall (UFW y firewall de tu proveedor de VPS)."
log_message "Puedes conectarte a tu VPS usando un cliente VNC en la IP de tu VPS y display $VNC_DISPLAY (ej. tu_ip:$VNC_DISPLAY)."
log_message "--------------------------------------------------------------------------------"

exit 0
